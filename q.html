<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>è³ªå•è©³ç´° | æ•´å½¢ç›¸è«‡å®¤</title>
  <link rel="stylesheet" href="./style.css"/>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">æ•´å½¢ç›¸è«‡å®¤ï¼ˆåŒ¿åQ&amp;Aï¼‰</div>
      <div class="tabs">
        <a class="tab" href="./index.html">ä¸€è¦§</a>
        <a class="tab" href="./ask.html">è³ªå•ã™ã‚‹</a>
        <a class="tab" href="./rank.html">ãƒ©ãƒ³ã‚­ãƒ³ã‚°</a>
      </div>
    </div>

    <div id="maintenanceBox" class="card" style="display:none"></div>

    <div id="qCard" class="card" style="margin-top:12px">
      <div class="muted small">è³ªå•</div>
      <h1 id="qTitle" style="margin:6px 0 10px 0; font-size:22px; line-height:1.2"></h1>

      <div class="row" style="gap:8px; flex-wrap:wrap; margin-bottom:10px">
        <button id="copyUrlBtn" class="btn ghost">URLã‚³ãƒ”ãƒ¼</button>
        <button id="watchBtn" class="btn ghost">â˜† ä¿å­˜</button>
        <button id="likeBtn" class="btn ghost">å…±æ„Ÿ</button>
      </div>

      <div class="row" style="margin-top:6px; gap:8px; flex-wrap:wrap">
        <button id="loginBtn" class="btn ghost" style="width:auto">Googleã§ãƒ­ã‚°ã‚¤ãƒ³ï¼ˆä»»æ„ï¼‰</button>
        <span class="muted">ãƒ©ãƒ³ã‚­ãƒ³ã‚°ç‹™ã†äººå‘ã‘ã€‚è³ªå•ã ã‘ãªã‚‰ä¸è¦ã€‚</span>
      </div>

      <div class="muted small" id="qMeta" style="margin-top:10px"></div>
      <div id="qBody" style="white-space:pre-wrap; margin-top:10px"></div>

      <div id="qDanger" class="danger small" style="display:none; margin-top:10px"></div>
    </div>

    <div id="answerComposer" class="card" style="margin-top:12px">
      <div class="row" style="justify-content:space-between; align-items:center">
        <div style="font-weight:700">å›ç­”ã™ã‚‹</div>
        <div class="muted small">ï¼ˆãƒ­ã‚°ã‚¤ãƒ³ä¸è¦ï¼‰</div>
      </div>

      <div class="muted small" style="margin-top:6px">ã§ãã‚‹ã ã‘å…·ä½“çš„ã«ã€‚çµŒé¨“è«‡ã‚„æ ¹æ‹ ãŒã‚ã‚‹ã¨å¼·ã„ã§ã™ã€‚</div>

      <textarea id="ansTa" class="textarea" placeholder="å›ç­”ã‚’æ›¸ã„ã¦ãã ã•ã„"></textarea>

      <div class="row" style="gap:8px; flex-wrap:wrap; margin-top:8px">
        <input id="ansX" class="input" style="flex:1; min-width:220px" placeholder="å›ç­”è€…ã®Xï¼ˆä»»æ„ï¼‰ä¾‹ï¼š@xxxx / https://x.com/xxxx">
        <button id="postAnsBtn" class="btn primary">å›ç­”ã‚’æŠ•ç¨¿</button>
      </div>

      <div id="ansWarn" class="danger small" style="display:none; margin-top:8px"></div>
    </div>

    <!-- â˜…è¿½åŠ ï¼šå›ç­”ä¸¦ã³æ›¿ãˆ -->
    <div class="card" style="margin-top:12px">
      <div class="muted small" style="margin-bottom:6px">å›ç­”ã®ä¸¦ã³æ›¿ãˆï¼ˆãƒ™ã‚¹ãƒˆã¯å¸¸ã«æœ€ä¸Šéƒ¨ï¼‰</div>
      <select id="answerSortSel" class="select" style="width:100%">
        <option value="helpful">å‚è€ƒã«ãªã£ãŸé †ï¼ˆãŠã™ã™ã‚ï¼‰</option>
        <option value="new">æ–°ã—ã„é †</option>
        <option value="old">å¤ã„é †</option>
      </select>
    </div>

    <div id="answersBox" class="card" style="margin-top:12px">
      <div class="row" style="justify-content:space-between; align-items:center">
        <div style="font-weight:700">å›ç­”ä¸€è¦§</div>
        <div class="muted small" id="ansCount"></div>
      </div>
      <div id="answersInner" style="margin-top:10px"></div>
    </div>

    <div id="relatedBox" class="card" style="margin-top:12px">
      <div class="row" style="justify-content:space-between; align-items:center">
        <div style="font-weight:700">é–¢é€£è³ªå•</div>
        <div class="muted small" id="relCount"></div>
      </div>
      <div id="relatedInner" style="margin-top:10px"></div>
    </div>

  </div>

<script type="module">
  import {
    // auth + util
    ensureAnonAuth, optionalGoogleLogin, currentUid, esc, tokenize, andMatch, containsDanger,

    // site
    getSiteConfig,

    // question
    getQuestion, updateQuestion, softDeleteQuestion, toggleLikeQuestion, isLiked,
    toggleWatchQuestion, isWatching, copyToClipboard,

    // answers
    listAnswers, addAnswer, updateAnswer, softDeleteAnswer,
    toggleHelpful, isHelpful, setBestAnswer, setThanks,

    // replies
    listReplies, addReply, updateReply, softDeleteReply,

    // reports
    createReport,

    // related
    listQuestions
  } from "./app.js";

  // ===== state =====
  const params = new URLSearchParams(location.search);
  const qid = params.get("id");
  let qData = null;

  // å›ç­”ä¸¦ã³æ›¿ãˆçŠ¶æ…‹
  let answerSort = "helpful"; // helpful/new/old

  // ===== dom =====
  const maintenanceBox = document.getElementById("maintenanceBox");

  const qTitle = document.getElementById("qTitle");
  const qBody  = document.getElementById("qBody");
  const qMeta  = document.getElementById("qMeta");
  const qDanger = document.getElementById("qDanger");

  const copyUrlBtn = document.getElementById("copyUrlBtn");
  const watchBtn = document.getElementById("watchBtn");
  const likeBtn = document.getElementById("likeBtn");
  const loginBtn = document.getElementById("loginBtn");

  const ansTa = document.getElementById("ansTa");
  const ansX = document.getElementById("ansX");
  const postAnsBtn = document.getElementById("postAnsBtn");
  const ansWarn = document.getElementById("ansWarn");

  const answerSortSel = document.getElementById("answerSortSel");

  const ansCount = document.getElementById("ansCount");
  const answersInner = document.getElementById("answersInner");

  const relatedInner = document.getElementById("relatedInner");
  const relCount = document.getElementById("relCount");

  // ===== helpers =====
  function fmtTime(ts){
    try{
      if(!ts) return "";
      const d = ts?.toDate ? ts.toDate() : new Date((ts.seconds||0)*1000);
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,"0");
      const da = String(d.getDate()).padStart(2,"0");
      const hh = String(d.getHours()).padStart(2,"0");
      const mm = String(d.getMinutes()).padStart(2,"0");
      return `${y}/${m}/${da} ${hh}:${mm}`;
    }catch{
      return "";
    }
  }

  function showWarn(el, msg){
    if(!msg){
      el.style.display="none";
      el.textContent="";
      return;
    }
    el.style.display="block";
    el.textContent=msg;
  }

  function parseX(input){
    const s = (input||"").trim();
    if(!s) return "";
    // @name / name / https://x.com/name
    const m = s.match(/(?:x\.com\/|twitter\.com\/)?@?([A-Za-z0-9_]{1,15})/);
    if(m && m[1]) return "@"+m[1];
    return s.slice(0,80);
  }

  function linkifyX(handleOrUrl){
    const s = (handleOrUrl||"").trim();
    if(!s) return "";
    const h = parseX(s);
    if(h.startsWith("@")){
      const name = h.slice(1);
      return `<a href="https://x.com/${esc(name)}" target="_blank" rel="noopener">${esc(h)}</a>`;
    }
    // URLã£ã½ã„ãªã‚‰ãã®ã¾ã¾
    if(/^https?:\/\//.test(s)){
      return `<a href="${esc(s)}" target="_blank" rel="noopener">X</a>`;
    }
    return esc(s);
  }

  // ===== maintenance =====
  async function checkMaintenance(){
    const cfg = await getSiteConfig();
    if(cfg.maintenance){
      maintenanceBox.style.display = "block";
      maintenanceBox.innerHTML = `
        <div style="font-weight:700">ç¾åœ¨ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ä¸­</div>
        <div class="muted small" style="margin-top:6px">${esc(cfg.message||"ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„")}</div>
      `;
    }else{
      maintenanceBox.style.display = "none";
    }
  }

  // ===== header actions =====
  async function refreshLikeWatchUI(){
    const liked = await isLiked(qid);
    likeBtn.textContent = liked ? "å…±æ„Ÿæ¸ˆã¿" : "å…±æ„Ÿ";

    const watching = await isWatching(qid);
    watchBtn.textContent = watching ? "â˜… ä¿å­˜æ¸ˆã¿" : "â˜† ä¿å­˜";
  }

  // ===== render question =====
  async function renderQuestion(){
    if(!qid){
      qTitle.textContent = "URLãŒä¸æ­£ã§ã™";
      qBody.textContent = "";
      return;
    }

    const q = await getQuestion(qid);
    if(!q){
      qTitle.textContent = "è³ªå•ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“";
      qBody.textContent = "";
      return;
    }
    qData = q.data;

    qTitle.textContent = qData.title || "(ç„¡é¡Œ)";
    qBody.textContent  = qData.body || "";

    const created = fmtTime(qData.createdAt);
    const likeC = qData.likeCount || 0;
    const ansC = qData.answerCount || 0;
    const best = qData.bestAnswerId ? "ğŸŸ¡ è§£æ±º" : "ğŸŸ¡ æœªè§£æ±º";

    qMeta.textContent = `å…±æ„Ÿ:${likeC} / å›ç­”:${ansC} / ä½œæˆ:${created} / ${best}`;

    // æ³¨æ„ãƒ¯ãƒ¼ãƒ‰
    const dangerHit = containsDanger((qData.title||"") + "\n" + (qData.body||""));
    showWarn(qDanger, dangerHit ? "æ³¨æ„ï¼šæ–­å®šãƒ»æ”»æ’ƒãƒ¯ãƒ¼ãƒ‰ãŒå«ã¾ã‚Œã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚è¡¨ç¾ã®è¦‹ç›´ã—ã‚’æ¨å¥¨ã€‚" : "");

    await refreshLikeWatchUI();
  }

  // ===== render answers (best fixed + sort) =====
  async function renderAnswers(){
    answersInner.innerHTML = `<div class="muted">èª­ã¿è¾¼ã¿ä¸­...</div>`;

    const list = await listAnswers(qid);
    const live = (list||[]).filter(a => !a.data?.deleted);

    ansCount.textContent = `(${live.length}ä»¶)`;

    if(!live.length){
      answersInner.innerHTML = `<div class="muted">ã¾ã å›ç­”ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</div>`;
      return;
    }

    // ãƒ™ã‚¹ãƒˆã‚’å…ˆé ­ã«å›ºå®š
    const best = live.find(a => a.data?.best);
    let others = live.filter(a => !a.data?.best);

    // ä¸¦ã³æ›¿ãˆï¼ˆãƒ™ã‚¹ãƒˆä»¥å¤–ï¼‰
    if(answerSort === "helpful"){
      others.sort((a,b)=>(b.data?.helpfulCount||0)-(a.data?.helpfulCount||0));
    }else if(answerSort === "new"){
      others.sort((a,b)=>(b.data?.createdAt?.seconds||0)-(a.data?.createdAt?.seconds||0));
    }else if(answerSort === "old"){
      others.sort((a,b)=>(a.data?.createdAt?.seconds||0)-(b.data?.createdAt?.seconds||0));
    }

    const final = best ? [best, ...others] : others;

    // ã„ã£ãŸã‚“ç©ºã«ã—ã¦DOMã§ç©ã‚€ï¼ˆã‚¤ãƒ™ãƒ³ãƒˆã‚’å£Šã—ã«ãã„ï¼‰
    answersInner.innerHTML = "";

    for(const a of final){
      const d = a.data || {};
      const mine = d.ownerUid && currentUid && d.ownerUid === currentUid;
      const isOwner = qData?.ownerUid && currentUid && qData.ownerUid === currentUid; // è³ªå•è€…ã‹ï¼Ÿ

      const wrap = document.createElement("div");
      wrap.className = "ans";

      // ãƒ˜ãƒƒãƒ€/æœ¬æ–‡
      const xHtml = d.xHandle ? `<span class="pill">X:${linkifyX(d.xHandle)}</span>` : "";

      wrap.innerHTML = `
        <div class="ansHead">
          <b>${d.best ? "ğŸ† ãƒ™ã‚¹ãƒˆã‚¢ãƒ³ã‚µãƒ¼" : "å›ç­”"}</b>
          <span class="muted small">${esc(fmtTime(d.createdAt))}</span>
          <span class="pill">å‚è€ƒ:${esc(d.helpfulCount||0)}</span>
          ${xHtml}
          ${d.best ? `<span class="pill">é¸ã°ã‚Œã¾ã—ãŸ</span>` : ``}
        </div>

        <div class="ansBody" style="white-space:pre-wrap">${esc(d.body||"")}</div>

        <div class="row" style="gap:8px; flex-wrap:wrap; margin-top:10px">
          <button class="btn ghost" data-act="helpful" data-aid="${a.id}">å‚è€ƒã«ãªã£ãŸ</button>
          <button class="btn ghost" data-act="report" data-aid="${a.id}">é€šå ±</button>
          ${isOwner && !d.best ? `<button class="btn ghost" data-act="best" data-aid="${a.id}">ãƒ™ã‚¹ãƒˆã«ã™ã‚‹</button>` : ``}
          ${isOwner ? `<button class="btn ghost" data-act="thanks" data-aid="${a.id}">ãŠç¤¼</button>` : ``}
          ${mine ? `<button class="btn ghost" data-act="edit" data-aid="${a.id}">ç·¨é›†</button>` : ``}
          ${mine ? `<button class="btn ghost danger" data-act="del" data-aid="${a.id}">å‰Šé™¤</button>` : ``}
        </div>

        <div id="thBox_${a.id}" class="card" style="display:none; margin-top:10px">
          <div class="muted small">ãŠç¤¼ã‚³ãƒ¡ãƒ³ãƒˆï¼ˆè³ªå•è€…ã®ã¿ï¼‰</div>
          <textarea class="textarea" id="thTa_${a.id}" style="min-height:70px" placeholder="ãŠç¤¼ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ›¸ã„ã¦ãã ã•ã„"></textarea>
          <div class="row" style="gap:8px; flex-wrap:wrap; margin-top:6px">
            <button class="btn primary" data-act="thanksSave" data-aid="${a.id}">ä¿å­˜</button>
            <button class="btn ghost" data-act="thanksCancel" data-aid="${a.id}">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          </div>
          <div class="danger small" id="thWarn_${a.id}" style="display:none; margin-top:6px"></div>
        </div>

        <div id="edBox_${a.id}" class="card" style="display:none; margin-top:10px">
          <div class="muted small">å›ç­”ã‚’ç·¨é›†</div>
          <textarea class="textarea" id="edTa_${a.id}" style="min-height:90px"></textarea>
          <div class="row" style="gap:8px; flex-wrap:wrap; margin-top:6px">
            <button class="btn primary" data-act="editSave" data-aid="${a.id}">ä¿å­˜</button>
            <button class="btn ghost" data-act="editCancel" data-aid="${a.id}">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          </div>
          <div class="danger small" id="edWarn_${a.id}" style="display:none; margin-top:6px"></div>
        </div>

        <div style="margin-top:12px">
          <div class="muted small">è¿”ä¿¡</div>
          <div id="replyList_${a.id}" style="margin-top:8px"></div>
          <!-- â˜…é †ç•ªå¤‰æ›´ï¼šè¿”ä¿¡ä¸€è¦§ã®ã€Œå¾Œã€ã«å…¥åŠ›æ¬„ -->
          <div id="replyComposer_${a.id}" style="margin-top:10px"></div>
        </div>
      `;

      answersInner.appendChild(wrap);

      // ãƒœã‚¿ãƒ³çŠ¶æ…‹ï¼ˆå‚è€ƒæ¸ˆã¿ï¼‰
      try{
        const h = await isHelpful(qid, a.id);
        if(h){
          const btn = wrap.querySelector(`[data-act="helpful"][data-aid="${a.id}"]`);
          if(btn) btn.textContent = "å‚è€ƒæ¸ˆã¿";
        }
      }catch{}

      // ãŠç¤¼æ—¢å­˜è¡¨ç¤º
      if(d.thanksText){
        const thBox = wrap.querySelector(`#thBox_${a.id}`);
        if(thBox){
          thBox.style.display = "block";
          const ta = wrap.querySelector(`#thTa_${a.id}`);
          if(ta) ta.value = d.thanksText;
        }
      }

      // è¿”ä¿¡ï¼šæç”» â†’ è¿”ä¿¡å…¥åŠ›æ¬„
      await renderReplies(a.id);
      renderReplyComposer(a.id);
    }

    // ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆanswersInnerå…¨ä½“ã§ä¸€æ‹¬ï¼‰
    answersInner.querySelectorAll("button[data-act]").forEach(btn=>{
      btn.addEventListener("click", async ()=>{
        const act = btn.dataset.act;
        const aid = btn.dataset.aid;

        // helpful
        if(act === "helpful"){
          try{
            const r = await toggleHelpful(qid, aid);
            btn.textContent = r.helpful ? "å‚è€ƒæ¸ˆã¿" : "å‚è€ƒã«ãªã£ãŸ";
            await renderQuestion(); // answerCount/likeãªã©ã®æ›´æ–°ã¨åŒæ§˜ã«è»½ãæ›´æ–°
            await renderAnswers();  // æ•°å­—æ›´æ–°
          }catch(e){
            alert("å‚è€ƒã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ");
            console.error(e);
          }
          return;
        }

        // report
        if(act === "report"){
          const reason = prompt("é€šå ±ç†ç”±ï¼ˆä»»æ„ï¼‰");
          try{
            await createReport({ type:"answer", qid, aid, reason: reason||"" });
            alert("é€šå ±ã—ã¾ã—ãŸã€‚ã”å”åŠ›ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚");
          }catch(e){
            alert("é€šå ±ã«å¤±æ•—ã—ã¾ã—ãŸ");
            console.error(e);
          }
          return;
        }

        // best
        if(act === "best"){
          if(!confirm("ã“ã®å›ç­”ã‚’ãƒ™ã‚¹ãƒˆã‚¢ãƒ³ã‚µãƒ¼ã«ã—ã¾ã™ã‹ï¼Ÿ")) return;
          try{
            await setBestAnswer(qid, aid);
            await renderQuestion();
            await renderAnswers();
          }catch(e){
            alert("ãƒ™ã‚¹ãƒˆè¨­å®šã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆè³ªå•è€…ã®ã¿ï¼‰");
            console.error(e);
          }
          return;
        }

        // thanks open
        if(act === "thanks"){
          const box = document.getElementById(`thBox_${aid}`);
          if(box) box.style.display = (box.style.display==="none" ? "block" : "none");
          return;
        }

        if(act === "thanksCancel"){
          const box = document.getElementById(`thBox_${aid}`);
          if(box) box.style.display = "none";
          return;
        }

        if(act === "thanksSave"){
          const ta = document.getElementById(`thTa_${aid}`);
          const warn = document.getElementById(`thWarn_${aid}`);
          const text = (ta?.value||"").trim();
          if(text.length > 400){
            warn.style.display="block";
            warn.textContent="ãŠç¤¼ã‚³ãƒ¡ãƒ³ãƒˆã¯400æ–‡å­—ä»¥å†…ã«ã—ã¦ãã ã•ã„ã€‚";
            return;
          }
          try{
            await setThanks(qid, aid, text);
            if(warn){ warn.style.display="none"; warn.textContent=""; }
            alert("ä¿å­˜ã—ã¾ã—ãŸ");
            await renderAnswers();
          }catch(e){
            if(warn){
              warn.style.display="block";
              warn.textContent="ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆè³ªå•è€…ã®ã¿ï¼‰";
            }
            console.error(e);
          }
          return;
        }

        // edit open
        if(act === "edit"){
          const box = document.getElementById(`edBox_${aid}`);
          const ta = document.getElementById(`edTa_${aid}`);
          if(box){
            box.style.display = (box.style.display==="none" ? "block" : "none");
            if(ta){
              // ç¾åœ¨æœ¬æ–‡ã‚’æ‹¾ã†ï¼ˆè¡¨ç¤ºã‹ã‚‰ï¼‰
              const ansBody = box.parentElement?.querySelector(".ansBody");
              ta.value = ansBody ? ansBody.textContent : "";
            }
          }
          return;
        }

        if(act === "editCancel"){
          const box = document.getElementById(`edBox_${aid}`);
          if(box) box.style.display="none";
          return;
        }

        if(act === "editSave"){
          const ta = document.getElementById(`edTa_${aid}`);
          const warn = document.getElementById(`edWarn_${aid}`);
          const text = (ta?.value||"").trim();
          if(!text){
            warn.style.display="block";
            warn.textContent="æœ¬æ–‡ãŒç©ºã§ã™ã€‚";
            return;
          }
          if(text.length > 2000){
            warn.style.display="block";
            warn.textContent="æœ¬æ–‡ã¯2000æ–‡å­—ä»¥å†…ã«ã—ã¦ãã ã•ã„ã€‚";
            return;
          }
          try{
            await updateAnswer(qid, aid, { body:text });
            if(warn){ warn.style.display="none"; warn.textContent=""; }
            alert("æ›´æ–°ã—ã¾ã—ãŸ");
            await renderAnswers();
          }catch(e){
            if(warn){
              warn.style.display="block";
              warn.textContent="æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆè‡ªåˆ†ã®æŠ•ç¨¿ã®ã¿ï¼‰";
            }
            console.error(e);
          }
          return;
        }

        // delete
        if(act === "del"){
          if(!confirm("ã“ã®å›ç­”ã‚’å‰Šé™¤ï¼ˆã‚½ãƒ•ãƒˆå‰Šé™¤ï¼‰ã—ã¾ã™ã‹ï¼Ÿ")) return;
          try{
            await softDeleteAnswer(qid, aid);
            await renderQuestion();
            await renderAnswers();
          }catch(e){
            alert("å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆè‡ªåˆ†ã®æŠ•ç¨¿ã®ã¿ï¼‰");
            console.error(e);
          }
          return;
        }
      });
    });
  }

  // ===== replies =====
  async function renderReplies(aid){
    const root = document.getElementById("replyList_"+aid);
    if(!root) return;

    root.innerHTML = `<span class="muted">èª­ã¿è¾¼ã¿ä¸­...</span>`;
    let list = [];
    try{
      list = await listReplies(qid, aid);
    }catch(e){
      root.innerHTML = `<span class="danger small">è¿”ä¿¡ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</span>`;
      console.error(e);
      return;
    }

    const live = (list||[]).filter(r => !r.data?.deleted);

    if(!live.length){
      root.innerHTML = `<span class="muted">è¿”ä¿¡ãªã—</span>`;
      return;
    }

    const html = live.map(r=>{
      const d = r.data || {};
      const mine = d.ownerUid && currentUid && d.ownerUid === currentUid;

      return `
        <div class="card" style="margin:8px 0">
          <div class="row" style="justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap">
            <div class="muted small">${esc(fmtTime(d.createdAt))}</div>
            <div class="row" style="gap:8px">
              <button class="btn ghost" data-ract="rreport" data-aid="${aid}" data-rid="${r.id}">é€šå ±</button>
              ${mine ? `<button class="btn ghost" data-ract="redit" data-aid="${aid}" data-rid="${r.id}">ç·¨é›†</button>` : ``}
              ${mine ? `<button class="btn ghost danger" data-ract="rdel" data-aid="${aid}" data-rid="${r.id}">å‰Šé™¤</button>` : ``}
            </div>
          </div>

          <div id="rb_${aid}_${r.id}" style="white-space:pre-wrap; margin-top:6px">${esc(d.body||"")}</div>

          <div id="re_${aid}_${r.id}" class="card" style="display:none; margin-top:10px">
            <div class="muted small">è¿”ä¿¡ã‚’ç·¨é›†</div>
            <textarea class="textarea" id="reTa_${aid}_${r.id}" style="min-height:70px"></textarea>
            <div class="row" style="gap:8px; margin-top:6px">
              <button class="btn primary" data-ract="rsave" data-aid="${aid}" data-rid="${r.id}">ä¿å­˜</button>
              <button class="btn ghost" data-ract="rcancel" data-aid="${aid}" data-rid="${r.id}">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            </div>
            <div class="danger small" id="reWarn_${aid}_${r.id}" style="display:none; margin-top:6px"></div>
          </div>
        </div>
      `;
    }).join("");

    root.innerHTML = html;

    // events
    root.querySelectorAll("button[data-ract]").forEach(btn=>{
      btn.addEventListener("click", async ()=>{
        const act = btn.dataset.ract;
        const rid = btn.dataset.rid;

        if(act === "rreport"){
          const reason = prompt("é€šå ±ç†ç”±ï¼ˆä»»æ„ï¼‰");
          try{
            await createReport({ type:"reply", qid, aid, rid, reason: reason||"" });
            alert("é€šå ±ã—ã¾ã—ãŸã€‚");
          }catch(e){
            alert("é€šå ±ã«å¤±æ•—ã—ã¾ã—ãŸ");
            console.error(e);
          }
          return;
        }

        if(act === "redit"){
          const box = document.getElementById(`re_${aid}_${rid}`);
          const ta  = document.getElementById(`reTa_${aid}_${rid}`);
          const body = document.getElementById(`rb_${aid}_${rid}`);
          if(box && ta){
            box.style.display = "block";
            ta.value = body ? body.textContent : "";
          }
          return;
        }

        if(act === "rcancel"){
          const box = document.getElementById(`re_${aid}_${rid}`);
          if(box) box.style.display = "none";
          return;
        }

        if(act === "rsave"){
          const ta = document.getElementById(`reTa_${aid}_${rid}`);
          const warn = document.getElementById(`reWarn_${aid}_${rid}`);
          const text = (ta?.value||"").trim();
          if(!text){
            warn.style.display="block"; warn.textContent="æœ¬æ–‡ãŒç©ºã§ã™ã€‚";
            return;
          }
          if(text.length > 800){
            warn.style.display="block"; warn.textContent="è¿”ä¿¡ã¯800æ–‡å­—ä»¥å†…ã«ã—ã¦ãã ã•ã„ã€‚";
            return;
          }
          try{
            await updateReply(qid, aid, rid, { body:text });
            if(warn){ warn.style.display="none"; warn.textContent=""; }
            await renderReplies(aid);
          }catch(e){
            if(warn){ warn.style.display="block"; warn.textContent="æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆè‡ªåˆ†ã®æŠ•ç¨¿ã®ã¿ï¼‰"; }
            console.error(e);
          }
          return;
        }

        if(act === "rdel"){
          if(!confirm("ã“ã®è¿”ä¿¡ã‚’å‰Šé™¤ï¼ˆã‚½ãƒ•ãƒˆå‰Šé™¤ï¼‰ã—ã¾ã™ã‹ï¼Ÿ")) return;
          try{
            await softDeleteReply(qid, aid, rid);
            await renderReplies(aid);
          }catch(e){
            alert("å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆè‡ªåˆ†ã®æŠ•ç¨¿ã®ã¿ï¼‰");
            console.error(e);
          }
          return;
        }
      });
    });
  }

  function renderReplyComposer(aid){
    const box = document.getElementById("replyComposer_"+aid);
    if(!box) return;

    box.innerHTML = `
      <div class="card">
        <textarea class="textarea" id="rpTa_${aid}" style="min-height:70px" placeholder="å›ç­”ã¸ã®è¿”ä¿¡ã‚’æ›¸ãã¾ã™ï¼ˆãƒ­ã‚°ã‚¤ãƒ³ä¸è¦ï¼‰"></textarea>
        <div class="row" style="gap:8px; margin-top:8px">
          <button class="btn primary" data-rp="post" data-aid="${aid}">è¿”ä¿¡ã‚’æŠ•ç¨¿</button>
        </div>
        <div class="danger small" id="rpWarn_${aid}" style="display:none; margin-top:6px"></div>
      </div>
    `;

    const post = box.querySelector(`button[data-rp="post"][data-aid="${aid}"]`);
    post.addEventListener("click", async ()=>{
      const ta = document.getElementById("rpTa_"+aid);
      const warn = document.getElementById("rpWarn_"+aid);
      const text = (ta?.value||"").trim();

      if(!text){
        warn.style.display="block"; warn.textContent="æœ¬æ–‡ãŒç©ºã§ã™ã€‚";
        return;
      }
      if(text.length > 800){
        warn.style.display="block"; warn.textContent="è¿”ä¿¡ã¯800æ–‡å­—ä»¥å†…ã«ã—ã¦ãã ã•ã„ã€‚";
        return;
      }

      try{
        await addReply(qid, aid, { body:text });
        ta.value = "";
        warn.style.display="none"; warn.textContent="";
        await renderReplies(aid); // è¿”ä¿¡æ›´æ–°
      }catch(e){
        warn.style.display="block";
        warn.textContent="æŠ•ç¨¿ã«å¤±æ•—ã—ã¾ã—ãŸ";
        console.error(e);
      }
    });
  }

  // ===== related =====
  async function renderRelated(){
    relatedInner.innerHTML = `<div class="muted">èª­ã¿è¾¼ã¿ä¸­...</div>`;

    let all = [];
    try{
      all = await listQuestions();
    }catch(e){
      relatedInner.innerHTML = `<div class="muted">é–¢é€£è³ªå•ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</div>`;
      console.error(e);
      return;
    }

    const me = qData || {};
    const tokens = tokenize((me.title||"") + " " + (me.body||"")).slice(0,10);

    const candidates = all
      .filter(x => x.id !== qid)
      .filter(x => !x.data?.deleted)
      .map(x=>{
        const d = x.data || {};
        const hay = (d.title||"") + " " + (d.body||"");
        // ã‚†ã‚‹ã„ã‚¹ã‚³ã‚¢ï¼ˆå«æœ‰æ•°ï¼‰
        let score = 0;
        for(const t of tokens){
          if(t && hay.toLowerCase().includes(t)) score++;
        }
        return { id:x.id, data:d, score };
      })
      .filter(x => x.score >= 2) // è¿‘ã„ã‚‚ã®ã ã‘
      .sort((a,b)=>b.score - a.score)
      .slice(0, 8);

    relCount.textContent = `${candidates.length}ä»¶è¡¨ç¤º`;

    if(!candidates.length){
      relatedInner.innerHTML = `<div class="muted">é–¢é€£è³ªå•ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“</div>`;
      return;
    }

    relatedInner.innerHTML = candidates.map(x=>{
      const d = x.data || {};
      const sub = (d.body||"").trim().slice(0, 40);
      const likeC = d.likeCount||0;
      const ansC = d.answerCount||0;
      return `
        <a class="card" href="./q.html?id=${encodeURIComponent(x.id)}" style="display:block; text-decoration:none; color:inherit; margin:8px 0">
          <div style="font-weight:700">${esc(d.title||"(ç„¡é¡Œ)")}</div>
          <div class="muted small" style="margin-top:4px">${esc(sub)}${sub.length>=40 ? "â€¦" : ""}</div>
          <div class="muted small" style="margin-top:6px">${likeC}å…±æ„Ÿ / ${ansC}å›ç­”</div>
        </a>
      `;
    }).join("");
  }

  // ===== boot =====
  async function boot(){
    await ensureAnonAuth();
    await checkMaintenance();

    if(!qid){
      qTitle.textContent = "URLãŒä¸æ­£ã§ã™";
      return;
    }

    // sort UI
    answerSortSel.value = answerSort;
    answerSortSel.addEventListener("change", async ()=>{
      answerSort = answerSortSel.value;
      await renderAnswers();
    });

    // header buttons
    copyUrlBtn.addEventListener("click", async ()=>{
      await copyToClipboard(location.href);
      alert("URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ");
    });

    watchBtn.addEventListener("click", async ()=>{
      try{
        const r = await toggleWatchQuestion(qid);
        watchBtn.textContent = r.watching ? "â˜… ä¿å­˜æ¸ˆã¿" : "â˜† ä¿å­˜";
      }catch(e){
        alert("ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ");
        console.error(e);
      }
    });

    likeBtn.addEventListener("click", async ()=>{
      try{
        const r = await toggleLikeQuestion(qid);
        likeBtn.textContent = r.liked ? "å…±æ„Ÿæ¸ˆã¿" : "å…±æ„Ÿ";
        await renderQuestion();
      }catch(e){
        alert("å…±æ„Ÿã«å¤±æ•—ã—ã¾ã—ãŸ");
        console.error(e);
      }
    });

    loginBtn.addEventListener("click", async ()=>{
      const r = await optionalGoogleLogin();
      if(r.ok){
        alert("ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã—ãŸï¼ˆä»»æ„ï¼‰");
      }else{
        alert("ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸï¼š" + (r.error||""));
      }
    });

    // post answer
    postAnsBtn.addEventListener("click", async ()=>{
      showWarn(ansWarn, "");
      const body = (ansTa.value||"").trim();
      const xh = parseX(ansX.value);

      if(!body){
        showWarn(ansWarn, "æœ¬æ–‡ãŒç©ºã§ã™ã€‚");
        return;
      }
      if(body.length > 2000){
        showWarn(ansWarn, "æœ¬æ–‡ã¯2000æ–‡å­—ä»¥å†…ã«ã—ã¦ãã ã•ã„ã€‚");
        return;
      }

      try{
        await addAnswer(qid, { body, xHandle:xh });
        ansTa.value = "";
        ansX.value = "";
        await renderQuestion();
        await renderAnswers();
      }catch(e){
        showWarn(ansWarn, "æŠ•ç¨¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
        console.error(e);
      }
    });

    // åˆæœŸæç”»
    await renderQuestion();
    await renderAnswers();
    await renderRelated();
  }

  boot();
</script>
</body>
</html>

